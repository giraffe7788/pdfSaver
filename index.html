<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF ë¶„í• ì €ì¥ê¸°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container-fluid {
            height: 100vh;
            padding: 20px;
        }
        .left-panel {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .right-panel {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .upload-area {
            border: 3px dashed #dee2e6;
            border-radius: 10px;
            padding: 60px 20px;
            text-align: center;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #0d6efd;
            background-color: #f0f8ff;
        }
        .upload-icon {
            font-size: 48px;
            color: #6c757d;
            margin-bottom: 20px;
        }
        .table-container {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            max-height: 73vh;
        }
        .table thead {
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 10;
        }
        .btn-remove {
            padding: 2px 8px;
            font-size: 12px;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        #fileName {
            font-size: 14px;
            color: #198754;
            margin-top: 10px;
        }
        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .loading-overlay.active {
            display: flex;
        }
        .loading-content {
            text-align: center;
            color: white;
        }
        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #0d6efd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            font-size: 18px;
            font-weight: bold;
        }
        .loading-subtext {
            font-size: 14px;
            color: #ddd;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row h-100 g-3">
            <!-- ì™¼ìª½ -->
            <div class="col-md-5">
                <div class="left-panel">
                    <h3 class="mb-4">PDF íŒŒì¼ ì—…ë¡œë“œ</h3>
                    <div class="upload-area" onclick="document.getElementById('pdfFile').click()">
                        <div class="upload-icon">ğŸ“„</div>
                        <h5>í´ë¦­í•˜ì—¬ PDF íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</h5>
                        <p class="text-muted">ë˜ëŠ” íŒŒì¼ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                        <input type="file" id="pdfFile" accept="application/pdf" style="display: none;">
                    </div>
                    <div id="fileName"></div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½ -->
            <div class="col-md-7">
                <div class="right-panel">
                    <h3 class="mb-4">PDF ë¶„í•  ì„¤ì •</h3>

                    <div class="table-container">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 15%;">ì‹œì‘ í˜ì´ì§€</th>
                                    <th style="width: 15%;">ë í˜ì´ì§€</th>
                                    <th style="width: 55%;">íŒŒì¼ ì œëª©</th>
                                    <th style="width: 15%;">í–‰ì‚­ì œ</th>
                                </tr>
                            </thead>
                            <tbody id="pdfTable">
                                <tr>
                                    <td><input type="number" class="form-control form-control-sm" placeholder="í˜ì´ì§€ ì…ë ¥" min="1"></td>
                                    <td><input type="number" class="form-control form-control-sm" placeholder="í˜ì´ì§€ ì…ë ¥" min="1"></td>
                                    <td><input type="text" class="form-control form-control-sm" placeholder="íŒŒì¼ëª… ì…ë ¥"></td>
                                    <td class="text-center">
                                        <button class="btn btn-danger btn-sm btn-remove" onclick="removeRow(this)">ì‚­ì œ</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="addRow()">
                            <i class="bi bi-plus-circle"></i> í–‰ ì¶”ê°€
                        </button>
                        <button class="btn btn-primary" onclick="downloadPDFs()">
                            <i class="bi bi-download"></i> ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">PDF ì²˜ë¦¬ ì¤‘...</div>
            <div class="loading-subtext" id="loadingSubtext">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script>
        // PDF íŒŒì¼ ì„ íƒ ì²˜ë¦¬
        document.getElementById('pdfFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = 'ì„ íƒëœ íŒŒì¼: ' + file.name;
            }
        });

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì²˜ë¦¬
        const uploadArea = document.querySelector('.upload-area');

        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = '#0d6efd';
            this.style.backgroundColor = '#f0f8ff';
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.borderColor = '#dee2e6';
            this.style.backgroundColor = '';
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = '#dee2e6';
            this.style.backgroundColor = '';

            const file = e.dataTransfer.files[0];
            if (file && file.type === 'application/pdf') {
                document.getElementById('pdfFile').files = e.dataTransfer.files;
                document.getElementById('fileName').textContent = 'ì„ íƒëœ íŒŒì¼: ' + file.name;
            } else {
                Swal.fire({
                    icon: 'warning',
                    title: 'ì˜ëª»ëœ íŒŒì¼ í˜•ì‹',
                    text: 'PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.',
                    confirmButtonText: 'í™•ì¸'
                });
            }
        });

        // í–‰ ì¶”ê°€ í•¨ìˆ˜
        function addRow() {
            const tableBody = document.getElementById('pdfTable');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="number" class="form-control form-control-sm" placeholder="í˜ì´ì§€ ì…ë ¥" min="1"></td>
                <td><input type="number" class="form-control form-control-sm" placeholder="í˜ì´ì§€ ì…ë ¥" min="1"></td>
                <td><input type="text" class="form-control form-control-sm" placeholder="íŒŒì¼ëª… ì…ë ¥"></td>
                <td class="text-center">
                    <button class="btn btn-danger btn-sm btn-remove" onclick="removeRow(this)">ì‚­ì œ</button>
                </td>
            `;
            tableBody.appendChild(newRow);
        }

        // í–‰ ì œê±° í•¨ìˆ˜
        function removeRow(button) {
            const row = button.closest('tr');
            const tableBody = document.getElementById('pdfTable');

            // ìµœì†Œ 1ê°œ í–‰ì€ ìœ ì§€
            if (tableBody.children.length > 1) {
                row.remove();
            } else {
                Swal.fire({
                    icon: 'info',
                    title: 'ì‚­ì œ ë¶ˆê°€',
                    text: 'ìµœì†Œ 1ê°œì˜ í–‰ì€ í•„ìš”í•©ë‹ˆë‹¤.',
                    confirmButtonText: 'í™•ì¸'
                });
            }
        }

        // ë¡œë”© í‘œì‹œ í•¨ìˆ˜
        function showLoading(text = 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”') {
            const overlay = document.getElementById('loadingOverlay');
            const subtext = document.getElementById('loadingSubtext');
            subtext.textContent = text;
            overlay.classList.add('active');
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('active');
        }

        // PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        async function downloadPDFs() {
            const pdfFile = document.getElementById('pdfFile').files[0];
            if (!pdfFile) {
                Swal.fire({
                    icon: 'warning',
                    title: 'PDF íŒŒì¼ ì—†ìŒ',
                    text: 'PDF íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.',
                    confirmButtonText: 'í™•ì¸'
                });
                return;
            }

            const tableBody = document.getElementById('pdfTable');
            const rows = tableBody.querySelectorAll('tr');
            const splitData = [];

            // ë°ì´í„° ê²€ì¦
            for (let row of rows) {
                const inputs = row.querySelectorAll('input');
                const startPage = inputs[0].value;
                const endPage = inputs[1].value;
                const fileName = inputs[2].value;

                if (!startPage || !endPage || !fileName) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'ì…ë ¥ ëˆ„ë½',
                        text: 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.',
                        confirmButtonText: 'í™•ì¸'
                    });
                    return;
                }

                if (parseInt(startPage) > parseInt(endPage)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'ì˜ëª»ëœ í˜ì´ì§€ ë²”ìœ„',
                        text: 'ì‹œì‘ í˜ì´ì§€ê°€ ë í˜ì´ì§€ë³´ë‹¤ í´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                        confirmButtonText: 'í™•ì¸'
                    });
                    return;
                }

                splitData.push({
                    startPage: parseInt(startPage),
                    endPage: parseInt(endPage),
                    fileName: fileName
                });
            }

            try {
                showLoading('PDF íŒŒì¼ì„ ì½ëŠ” ì¤‘...');

                // PDF íŒŒì¼ì„ ArrayBufferë¡œ ì½ê¸°
                const arrayBuffer = await pdfFile.arrayBuffer();

                showLoading('PDF ë¬¸ì„œë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...');
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                const totalPages = pdfDoc.getPageCount();

                // í˜ì´ì§€ ë²”ìœ„ ê²€ì¦
                for (let data of splitData) {
                    if (data.startPage < 1 || data.endPage > totalPages) {
                        hideLoading();
                        Swal.fire({
                            icon: 'error',
                            title: 'í˜ì´ì§€ ë²”ìœ„ ì˜¤ë¥˜',
                            text: `í˜ì´ì§€ ë²”ìœ„ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ í˜ì´ì§€ ìˆ˜: ${totalPages}`,
                            confirmButtonText: 'í™•ì¸'
                        });
                        return;
                    }
                }

                // ZIP íŒŒì¼ ìƒì„±
                showLoading('ZIP íŒŒì¼ ìƒì„± ì¤‘...');
                const zip = new JSZip();

                // ê° ë¶„í•  ë°ì´í„°ì— ëŒ€í•´ PDF ìƒì„± í›„ ZIPì— ì¶”ê°€
                for (let i = 0; i < splitData.length; i++) {
                    const data = splitData[i];
                    showLoading(`PDF ìƒì„± ì¤‘... (${i + 1}/${splitData.length})`);

                    // ìƒˆ PDF ë¬¸ì„œ ìƒì„±
                    const newPdfDoc = await PDFLib.PDFDocument.create();

                    // ì§€ì •ëœ í˜ì´ì§€ ë²”ìœ„ë¥¼ ë³µì‚¬
                    const pageIndices = [];
                    for (let p = data.startPage - 1; p < data.endPage; p++) {
                        pageIndices.push(p);
                    }

                    const copiedPages = await newPdfDoc.copyPages(pdfDoc, pageIndices);
                    copiedPages.forEach(page => newPdfDoc.addPage(page));

                    // PDF ì €ì¥
                    const pdfBytes = await newPdfDoc.save();

                    // ZIPì— PDF ì¶”ê°€
                    zip.file(data.fileName + '.pdf', pdfBytes);
                }

                // ZIP íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
                showLoading('ì••ì¶• íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤€ë¹„ ì¤‘...');
                const zipBlob = await zip.generateAsync({ type: 'blob' });

                const url = URL.createObjectURL(zipBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'PDF_ë¶„í• íŒŒì¼.zip';
                link.click();

                // ë©”ëª¨ë¦¬ í•´ì œ
                URL.revokeObjectURL(url);

                hideLoading();
                Swal.fire({
                    icon: 'success',
                    title: 'ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!',
                    text: `ì´ ${splitData.length}ê°œì˜ PDF íŒŒì¼ì´ ì••ì¶•ë˜ì–´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`,
                    confirmButtonText: 'í™•ì¸'
                });

            } catch (error) {
                hideLoading();
                console.error('PDF ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'ì²˜ë¦¬ ì˜¤ë¥˜',
                    text: 'PDF ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message,
                    confirmButtonText: 'í™•ì¸'
                });
            }
        }
    </script>
</body>
</html>
